<html lang="en">
<head>
    <title>Chat</title>
</head>
<body>
<h3>Chat Test</h3>
<div>
    <form id='form' action="/users/avatar" method="post" enctype="multipart/form-data">
        <input id="file" type="file" name="avatar" />
        <button type="submit">Send</button>
    </form>
</div>

<script src="sendPost.js"></script>
<script>
    let token;

    const form = document.getElementById('form');
    const fileInput = document.getElementById('file');
    form.onsubmit = evt => {
        evt.preventDefault();

        const action = form.getAttribute('action');
        const formData = new FormData();
        const file = fileInput.files[0];
        formData.append('file', file);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', action, true);
        xhr.setRequestHeader('Authorization', token);
        xhr.send(formData);

        return false;
    };

    sendPost('http://localhost:3000/auth', {
        userName: 'Sasha',
        password: 'querty',
    }).then(response => {
        token = response.data.token;
        connect(token);
    }).catch(error => console.log(error));

    function connect(token) {
        const ws = new WebSocket(`ws://localhost:3000/ws-chat?token=${token}`);

        ws.onmessage = event => {
            console.log(event.data);
        };

        ws.onopen = () => {
            console.log('open');
            const message = JSON.stringify(createMessageAction());
            ws.send(message);
        };

        ws.onclose = event => {
            console.log(`close, code=${event.code}`);
        };
    }

    function createMessageAction() {
        return {
            type: "CREATE_CHAT_MESSAGE",
            payload: {
                receiver: "John Smith",
                content: "Hi, John! How are you?"
            }
        };
    }
</script>
</body>
</html>